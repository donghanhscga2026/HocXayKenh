<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>S∆° ƒë·ªì Nh√¢n m·∫°ch</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      :root {
        --text-color: #1F2937;
        --label-color: #6B7280;
        --border-color: #E5E7EB;
        --accent-color: #F59E0B;
        --accent-hover-color: #D97706;
        --card-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        --background-color: #F8F9FA;
        --card-bg-color: #FFFFFF;
      }

      body {
        font-family: 'Inter', sans-serif;
        background-color: var(--background-color);
        color: var(--text-color);
        margin: 0;
        padding: 28px;
        overflow: hidden;
      }

      .wrap {
        max-width: 1200px;
        margin: 0 auto;
        background: var(--card-bg-color);
        padding: 32px 40px;
        border-radius: 24px;
        box-shadow: var(--card-shadow);
        border: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        height: calc(100vh - 56px);
        box-sizing: border-box;
      }

      h1 {
        text-align: center;
        margin: 0 0 12px;
        font-size: 30px;
        font-weight: 700;
        background: linear-gradient(90deg, #FBBF24, #F59E0B);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-fill-color: transparent;
        flex-shrink: 0;
      }

      .controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 16px;
        margin-bottom: 16px;
        padding: 16px;
        background-color: #F9FAFB;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        flex-shrink: 0;
      }

      input[type=date] { padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-color); font-family: 'Inter', sans-serif; font-size: 14px; transition: all 0.2s ease; }
      input[type=date]:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2); outline: none; }

      button.filterBtn {
        background: var(--accent-color);
        color: #1F2937;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.2s ease;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
      }
      button.filterBtn:hover {
        background: var(--accent-hover-color);
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(217, 119, 6, 0.3);
      }

      .chart-container {
          flex-grow: 1;
          position: relative;
          border: 1px solid var(--border-color);
          border-radius: 12px;
          overflow: hidden;
      }

      #chart { width: 100%; height: 100%; }
      
      .loader-container {
          position: absolute; top: 0; left: 0; right: 0; bottom: 0;
          background-color: rgba(255,255,255,0.8);
          display: flex; align-items: center; justify-content: center;
          z-index: 10; flex-direction: column; gap: 10px;
          display: none;
      }
      .loader {
          border: 5px solid #f3f3f3; border-top: 5px solid var(--accent-color);
          border-radius: 50%; width: 50px; height: 50px;
          animation: spin 1s linear infinite;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      .node circle {
        cursor: pointer;
        stroke-width: 1.5px;
      }
      .node text {
        font: 12px 'Inter', sans-serif;
        paint-order: stroke;
        stroke: #fff;
        stroke-width: 3px;
        stroke-linecap: butt;
        stroke-linejoin: miter;
      }
      .link {
        fill: none;
        stroke: #D1D5DB;
        stroke-width: 1.5px;
      }
    </style>
</head>
<body>
  <div class="wrap">
    <h1>üå≥ S∆° ƒë·ªì C√¢y Nh√¢n M·∫°ch</h1>
    <div class="controls">
      <label>T·ª´: <input type="date" id="startDate"></label>
      <label>ƒê·∫øn: <input type="date" id="endDate"></label>
      <button class="filterBtn" id="btnFilter">üìä Xem S∆° ƒë·ªì</button>
    </div>
    <div class="chart-container">
        <svg id="chart"></svg>
        <div class="loader-container" id="loader">
            <div class="loader"></div>
            <span>ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...</span>
        </div>
    </div>
  </div>

<script>
    const loader = document.getElementById('loader');
    const btnFilter = document.getElementById('btnFilter');
    
    const today = new Date();
    const defaultStart = new Date("2025-09-25T00:00:00");
    document.getElementById('startDate').value = defaultStart.toISOString().split('T')[0];
    document.getElementById('endDate').value = today.toISOString().split('T')[0];

    function loadData() {
        loader.style.display = 'flex';
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        google.script.run
            .withSuccessHandler(data => {
                loader.style.display = 'none';
                drawTree(data);
            })
            .withFailureHandler(error => {
                loader.style.display = 'none';
                alert('L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message);
            })
            .getReferralTreeData(startDate, endDate);
    }

    btnFilter.addEventListener('click', loadData);
    
    function drawTree(treeData) {
        const svgElement = d3.select("#chart");
        svgElement.selectAll("*").remove();

        if (!treeData || !treeData.children || treeData.children.length === 0) {
            svgElement.append("text")
                .attr("x", "50%")
                .attr("y", "50%")
                .attr("text-anchor", "middle")
                .style("font-size", "16px")
                .style("fill", "#6B7280")
                .text("Kh√¥ng c√≥ d·ªØ li·ªáu trong kho·∫£ng th·ªùi gian n√†y.");
            return;
        }

        const width = document.getElementById('chart').clientWidth;
        const height = document.getElementById('chart').clientHeight;
        const margin = {top: 20, right: 150, bottom: 20, left: 40};

        const dx = 35; // TƒÉng kho·∫£ng c√°ch d·ªçc
        const dy = 200; // TƒÉng kho·∫£ng c√°ch ngang

        const tree = d3.tree().nodeSize([dx, dy]);
        const root = d3.hierarchy(treeData);

        root.x0 = height / 2;
        root.y0 = 0;
        root.descendants().forEach((d, i) => {
            d.id = i;
            d._children = d.children;
            if (d.depth > 0) d.children = null; // B·∫Øt ƒë·∫ßu ·ªü tr·∫°ng th√°i thu g·ªçn
        });

        const svg = svgElement.append("g")
            .attr("transform", `translate(${margin.left}, ${margin.top})`);
        
        const zoom = d3.zoom()
            .scaleExtent([0.1, 3]) // Gi·ªõi h·∫°n m·ª©c zoom
            .on("zoom", (event) => {
                svg.attr("transform", event.transform);
            });

        svgElement.call(zoom);

        let i = 0;
        update(root);
        
        // CƒÉn gi·ªØa s∆° ƒë·ªì ban ƒë·∫ßu
        const initialTransform = d3.zoomIdentity.translate(margin.left, height / 2).scale(0.8);
        svgElement.call(zoom.transform, initialTransform);


        function update(source) {
            const duration = 250;
            const nodes = root.descendants().reverse();
            const links = root.links();

            tree(root);

            let left = root;
            let right = root;
            root.eachBefore(node => {
                if (node.x < left.x) left = node;
                if (node.x > right.x) right = node;
            });
            
            const node = svg.selectAll("g.node")
                .data(nodes, d => d.id || (d.id = ++i));

            const nodeEnter = node.enter().append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${source.y0},${source.x0})`)
                .style("cursor", "pointer")
                .on("click", (event, d) => {
                    d.children = d.children ? null : d._children;
                    update(d);
                });

            nodeEnter.append("circle")
                .attr("r", 0);

            nodeEnter.append("text")
                .attr("dy", "0.31em")
                .attr("x", 10)
                .attr("text-anchor", "start")
                .text(d => d.data.name);

            const nodeUpdate = nodeEnter.merge(node);
            
            nodeUpdate.transition()
                .duration(duration)
                .attr("transform", d => `translate(${d.y},${d.x})`);

            nodeUpdate.select("circle")
                .attr("r", 6)
                .attr("stroke", d => d._children ? "var(--accent-color)" : "#ccc")
                .attr("fill", d => d._children ? "var(--accent-color)" : "#fff");

            const nodeExit = node.exit().transition()
                .duration(duration)
                .attr("transform", d => `translate(${source.y},${source.x})`)
                .remove();
            
            nodeExit.select("circle").attr("r", 0);

            const link = svg.selectAll("path.link")
                .data(links, d => d.target.id);

            const linkEnter = link.enter().insert("path", "g")
                .attr("class", "link")
                .attr("d", d => {
                    const o = {x: source.x0, y: source.y0};
                    return d3.linkHorizontal().x(d => d.y).y(d => d.x)({source: o, target: o});
                });
            
            link.merge(linkEnter).transition()
                .duration(duration)
                .attr("d", d3.linkHorizontal().x(d => d.y).y(d => d.x));

            link.exit().transition()
                .duration(duration)
                .attr("d", d => {
                    const o = {x: source.x, y: source.y};
                    return d3.linkHorizontal().x(d => d.y).y(d => d.x)({source: o, target: o});
                }).remove();

            nodes.forEach(d => {
                d.x0 = d.x;
                d.y0 = d.y;
            });
        }
    }
    
    // Initial load
    loadData();
</script>
</body>
</html>

