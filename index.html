<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc vi·ªán BRK - Ng√¢n h√†ng ph∆∞·ªõc b√°u</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-menu {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .nav-menu a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: opacity 0.3s;
        }

        .nav-menu a:hover {
            opacity: 0.8;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            color: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }

        .btn-login {
            background: white;
            color: #667eea;
            padding: 10px 25px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.3);
        }

        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 80px 20px;
            text-align: center;
        }

        .hero h1 {
            font-size: 48px;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .hero p {
            font-size: 20px;
            opacity: 0.95;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Courses Section */
        .courses-section {
            max-width: 1200px;
            margin: 60px auto;
            padding: 0 20px;
        }

        .section-title {
            font-size: 32px;
            margin-bottom: 40px;
            text-align: center;
            color: #333;
        }

        .courses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 30px;
        }

        .course-card {
            background: white;
            border-radius: 16px;
            padding: 0;
            /* Remove padding for image */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
            overflow: hidden;
            /* For image */
        }

        .course-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .course-image {
            width: 100%;
            aspect-ratio: 16 / 9;
            object-fit: cover;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: block;
        }

        .course-content {
            padding: 20px;
        }

        .course-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .course-icon {
            font-size: 32px;
            color: #667eea;
        }

        .course-title {
            font-size: 18px;
            font-weight: 700;
            margin: 0;
            color: #333;
            flex: 1;
        }

        .course-desc {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.6;
            font-size: 14px;
            text-align: justify;
        }

        .course-badges {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .badge-free {
            background: #10B981;
            color: white;
        }

        .badge-paid {
            background: #F59E0B;
            color: white;
        }

        .badge-activated {
            background: #3B82F6;
            color: white;
        }

        .course-actions {
            margin-top: 15px;
        }

        .btn-continue,
        .btn-activate,
        .btn-start {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
        }

        /* Course Progress Bar */
        .course-progress-container {
            margin: 10px 0;
            background: #e5e7eb;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            position: relative;
        }

        .course-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #34d399);
            width: 0%;
            transition: width 0.5s ease;
        }

        .percent-text {
            font-size: 12px;
            color: #64748b;
            font-weight: 600;
            margin-bottom: 5px;
            display: block;
        }

        .btn-continue {
            background: linear-gradient(90deg, #10b981, #059669);
            color: white;
        }

        .btn-continue:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-activate {
            background: linear-gradient(90deg, #f59e0b, #d97706);
            color: white;
        }

        .btn-activate:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4);
        }

        .btn-start {
            background: linear-gradient(90deg, #3b82f6, #2563eb);
            color: white;
        }

        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }

        /* Roadmap Section */
        .roadmap-section {
            max-width: 1200px;
            margin: 60px auto;
            padding: 40px 20px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .roadmap-container {
            position: relative;
            padding-left: 30px;
        }

        .roadmap-container::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #e0e0e0;
        }

        .roadmap-step {
            position: relative;
            margin-bottom: 30px;
            padding-left: 30px;
        }

        .roadmap-step::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ccc;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #ccc;
        }

        .roadmap-step.done::before {
            background: #10B981;
            box-shadow: 0 0 0 2px #10B981;
        }

        .roadmap-step.active::before {
            background: #F59E0B;
            box-shadow: 0 0 0 2px #F59E0B;
        }

        .step-content {
            background: #f9fafb;
            padding: 15px;
            border-radius: 10px;
        }

        .step-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }

        /* Footer */
        .footer {
            background: #2d3748;
            color: white;
            padding: 40px 20px;
            text-align: center;
            margin-top: 80px;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
        }

        .footer-links a {
            color: white;
            text-decoration: none;
            opacity: 0.8;
            transition: opacity 0.3s;
        }

        .footer-links a:hover {
            opacity: 1;
        }

        /* Alert/Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .toast.show {
            display: flex;
            animation: slideIn 0.3s ease-out;
        }

        .toast.success {
            border-left: 4px solid #10B981;
        }

        .toast.error {
            border-left: 4px solid #EF4444;
        }

        .toast.info {
            border-left: 4px solid #3B82F6;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 32px;
            }

            .hero p {
                font-size: 16px;
            }

            .courses-grid {
                grid-template-columns: 1fr;
            }

            .nav-menu {
                display: none;
            }
        }

        /* Modal Countdown */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 450px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-icon {
            font-size: 64px;
            color: #667eea;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
        }

        .modal-message {
            font-size: 16px;
            color: #666;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .countdown-timer {
            font-size: 48px;
            font-weight: 700;
            color: #667eea;
            margin: 20px 0;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .modal-btn {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 15px;
        }

        .modal-btn-primary {
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: white;
        }

        .modal-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .modal-btn-secondary {
            background: #e5e7eb;
            color: #666;
        }

        .modal-btn-secondary:hover {
            background: #d1d5db;
        }

        /* Loading Spinner */
        .loading-container {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: #666;
            font-size: 16px;
        }

        /* User Dropdown */
        .user-dropdown {
            position: relative;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 25px;
            transition: background 0.3s;
        }

        .user-info:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s;
        }

        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            padding: 12px 20px;
            color: #333;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
            cursor: pointer;
        }

        .dropdown-item:hover {
            background: #f3f4f6;
        }

        .dropdown-item i {
            width: 20px;
            text-align: center;
        }

        .dropdown-divider {
            height: 1px;
            background: #e5e7eb;
            margin: 5px 0;
        }

        /* Chatbot Styles */
        .chatbot-fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            transition: all 0.3s ease;
            z-index: 999;
        }

        .chatbot-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.5);
        }

        .chatbot-fab.active {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        .chatbot-container {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 380px;
            height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 40px rgba(0, 0, 0, 0.16);
            display: none;
            flex-direction: column;
            z-index: 998;
            animation: slideUp 0.3s ease;
        }

        .chatbot-container.active {
            display: flex;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chatbot-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chatbot-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .chatbot-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .chatbot-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .chatbot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #f9fafb;
        }

        .message {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.ai {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 12px;
            word-wrap: break-word;
            line-height: 1.4;
            font-size: 14px;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.ai .message-bubble {
            background: white;
            color: #333;
            border: 1px solid #e5e7eb;
            border-bottom-left-radius: 4px;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            align-items: center;
            padding: 12px 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ccc;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                opacity: 0.3;
            }
            30% {
                opacity: 1;
            }
        }

        .chatbot-input-area {
            padding: 15px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
        }

        .chatbot-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #e5e7eb;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .chatbot-input:focus {
            border-color: #667eea;
        }

        .chatbot-send {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
        }

        .chatbot-send:hover {
            transform: scale(1.05);
        }

        .chatbot-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 600px) {
            .chatbot-container {
                width: calc(100% - 40px);
                height: 400px;
                bottom: 90px;
                right: 20px;
            }

            .chatbot-fab {
                width: 50px;
                height: 50px;
                font-size: 24px;
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="logo">
                <i class="fas fa-graduation-cap"></i>
                <span>BRK</span>
            </div>
            <nav class="nav-menu">
                <a href="#home">Trang ch·ªß</a>
                <a href="#courses">Kh√≥a h·ªçc</a>
                <a href="#about">Gi·ªõi thi·ªáu</a>
            </nav>
            <div class="user-section" id="user-section">
                <!-- Dynamic content: Login button or User dropdown -->
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero">
        <h1>H·ªçc vi·ªán BRK - Ng√¢n h√†ng ph∆∞·ªõc b√°u</h1>
        <p>N∆°i kh∆°i ngu·ªìn tri th·ª©c, x√¢y d·ª±ng t∆∞∆°ng lai</p>
    </section>

    <!-- Roadmap Section (Only for logged-in users) - MOVED TO TOP -->
    <section class="roadmap-section hidden" id="roadmap-section">
        <h2 class="section-title">L·ªô Tr√¨nh H·ªçc T·∫≠p C·ªßa T√¥i</h2>
        <div class="roadmap-container" id="roadmap-container">
            <!-- Dynamic roadmap will be inserted here -->
        </div>
    </section>

    <!-- Courses Section -->
    <section class="courses-section" id="courses">
        <h2 class="section-title">Danh S√°ch Kh√≥a H·ªçc</h2>
        <!-- Loading State -->
        <div class="loading-container" id="loading-courses">
            <div class="spinner"></div>
            <p class="loading-text">ƒêang t·∫£i danh s√°ch kh√≥a h·ªçc...</p>
        </div>
        <!-- Courses Grid -->
        <div class="courses-grid hidden" id="courses-grid">
            <!-- Dynamic course cards will be inserted here -->
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-links">
                <a href="#"><i class="fab fa-facebook"></i> Facebook</a>
                <a href="#"><i class="fab fa-youtube"></i> YouTube</a>
                <a href="mailto:support@brk.com"><i class="fas fa-envelope"></i> Email</a>
            </div>
            <p>&copy; 2026 H·ªçc vi·ªán BRK. All rights reserved.</p>
        </div>
    </footer>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <i class="fas fa-info-circle"></i>
        <span id="toast-message"></span>
    </div>

    <!-- Modal Countdown -->
    <div class="modal-overlay hidden" id="login-modal">
        <div class="modal-content">
            <div class="modal-icon">
                <i class="fas fa-user-lock"></i>
            </div>
            <h3 class="modal-title">C·∫ßn ƒêƒÉng Nh·∫≠p</h3>
            <p class="modal-message">B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ k√≠ch ho·∫°t kh√≥a h·ªçc n√†y</p>
            <div class="countdown-timer" id="countdown">10</div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeLoginModal()">
                    <i class="fas fa-times"></i> ƒê·ªÉ sau
                </button>
                <button class="modal-btn modal-btn-primary" onclick="goToLogin()">
                    <i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p/ƒêƒÉng k√Ω
                </button>
            </div>
        </div>
    </div>

    <!-- Modal K√≠ch Ho·∫°t Kh√≥a H·ªçc -->
    <div class="modal-overlay hidden" id="activate-modal">
        <div class="modal-content" style="max-width: 550px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                <i class="fas fa-rocket"></i>
            </div>
            <h3 class="modal-title" id="activate-title">K√≠ch ho·∫°t kh√≥a h·ªçc</h3>

            <!-- Loading State -->
            <div id="activate-loading" style="display: none; padding: 40px; text-align: center;">
                <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #f59e0b; margin-bottom: 20px;"></i>
                <p style="color: #64748b; font-size: 16px; font-weight: 500;">ƒêang x·ª≠ l√Ω th√¥ng tin...</p>
                <p style="color: #94a3b8; font-size: 13px; margin-top: 8px;">Vui l√≤ng ch·ªù trong gi√¢y l√°t</p>
            </div>

            <div id="activate-body">
                <!-- Course Info -->
                <div id="activate-course-info"
                    style="margin: 20px 0; padding: 15px; background: #f8fafc; border-radius: 8px; text-align: left;">
                    <h4 style="margin: 0 0 8px 0; color: #1e293b; font-size: 16px;" id="activate-course-name"></h4>
                    <p style="margin: 0; color: #64748b; font-size: 14px;" id="activate-course-desc"></p>
                </div>

                <!-- Waiver Info (Mi·ªÖn c·ªçc) -->
                <div id="waiver-info"
                    style="display: none; margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 12px; color: white; text-align: center;">
                    <i class="fas fa-gift" style="font-size: 32px; margin-bottom: 10px;"></i>
                    <p style="margin: 0; font-size: 16px; font-weight: 600;">üéâ B·∫°n ƒë∆∞·ª£c mi·ªÖn ph√≠ cam k·∫øt!</p>
                    <p style="margin: 8px 0 0 0; font-size: 14px; opacity: 0.9;">V√¨ b·∫°n ƒë√£ tham gia L·ªô tr√¨nh 86 ng√†y</p>
                </div>

                <!-- Deposit Info (C√≥ c·ªçc) -->
                <div id="deposit-info" style="display: none; margin: 20px 0; text-align: left;">
                    <div
                        style="padding: 15px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 8px; margin-bottom: 15px;">
                        <p style="margin: 0 0 8px 0; font-weight: 600; color: #92400e;">
                            <i class="fas fa-coins"></i> Ph√≠ cam k·∫øt: <span id="deposit-amount"
                                style="color: #d97706; font-size: 18px;"></span>
                        </p>
                        <ul style="margin: 8px 0 0 20px; padding: 0; color: #78350f; font-size: 14px;">
                            <li><strong>STK:</strong> <span id="deposit-stk"></span></li>
                            <li><strong>T√™n:</strong> <span id="deposit-name"></span></li>
                            <li><strong>Ng√¢n h√†ng:</strong> <span id="deposit-bank"></span></li>
                            <li><strong>N·ªôi dung:</strong> <span id="deposit-content"></span></li>
                        </ul>
                    </div>

                    <!-- QR Code -->
                    <div style="text-align: center; margin-bottom: 15px;">
                        <img id="deposit-qr" src="" alt="QR Code"
                            style="max-width: 200px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none;">
                    </div>

                    <!-- File Upload -->
                    <div style="margin-top: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b;">
                            <i class="fas fa-upload"></i> Upload ·∫£nh minh ch·ª©ng:
                        </label>
                        <input type="file" id="activate-receipt" accept="image/*"
                            style="display: block; width: 100%; padding: 10px; border: 2px dashed #cbd5e1; border-radius: 8px; cursor: pointer;">
                        <img id="activate-preview" src="" alt="Preview"
                            style="display: none; width: 100%; aspect-ratio: 16 / 9; object-fit: cover; margin-top: 10px; border-radius: 8px;">
                    </div>
                </div>

                <!-- Buttons -->
                <div class="modal-buttons" style="margin-top: 20px;">
                    <button class="modal-btn modal-btn-secondary" onclick="closeActivateModal()">
                        <i class="fas fa-times"></i> H·ªßy
                    </button>
                    <button class="modal-btn modal-btn-primary" id="confirm-activate-btn" onclick="confirmActivation()"
                        style="background: linear-gradient(90deg, #f59e0b, #d97706);">
                        <i class="fas fa-check"></i> X√°c nh·∫≠n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwd9qsO3FlcwNMOWBqPm5c7NWb0d5c8hMCd5o2YzeXlFOQMVayvHErqcUcWHrelojIbeA/exec";

        // Check login status
        const user = localStorage.getItem('user');
        const isLoggedIn = !!user;
        let userData = null;
        let courses = []; // Global courses array

        if (isLoggedIn) {
            userData = JSON.parse(user);
        }

        // Initialize page
        window.addEventListener('load', () => {
            renderHeader();
            loadCourses();
            if (isLoggedIn) {
                loadRoadmap();
            }
        });

        // Render Header
        function renderHeader() {
            const userSection = document.getElementById('user-section');

            if (isLoggedIn) {
                const initial = userData.name ? userData.name.charAt(0).toUpperCase() : 'U';
                userSection.innerHTML = `
                    <div class="user-dropdown">
                        <div class="user-info" onclick="toggleDropdown()">
                            <div class="user-avatar">${initial}</div>
                            <span>${userData.name}</span>
                            <i class="fas fa-chevron-down" style="font-size: 12px;"></i>
                        </div>
                        <div class="dropdown-menu" id="user-dropdown-menu">
                            <div class="dropdown-item" onclick="editProfile()">
                                <i class="fas fa-user-edit"></i>
                                <span>S·ª≠a th√¥ng tin</span>
                            </div>
                            <div class="dropdown-item" onclick="changePassword()">
                                <i class="fas fa-key"></i>
                                <span>ƒê·ªïi m·∫≠t kh·∫©u</span>
                            </div>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-item" onclick="logout()">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>ƒêƒÉng xu·∫•t</span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                userSection.innerHTML = `
                    <a href="login.html" class="btn-login">ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω</a>
                `;
            }
        }

        // Toggle Dropdown Menu
        function toggleDropdown() {
            const dropdown = document.getElementById('user-dropdown-menu');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('user-dropdown-menu');
            const userInfo = document.querySelector('.user-info');
            if (dropdown && !userInfo?.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Logout
        function logout() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
                localStorage.removeItem('user');
                localStorage.removeItem('password');
                // Clear courses and roadmap cache
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('courses_') || key.startsWith('roadmap_')) {
                        localStorage.removeItem(key);
                    }
                });
                showToast('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
        }

        // Edit Profile
        function editProfile() {
            // TODO: Open edit profile modal
            showToast('T√≠nh nƒÉng ƒëang ph√°t tri·ªÉn!', 'info');
        }

        // Change Password
        function changePassword() {
            // TODO: Open change password modal
            showToast('T√≠nh nƒÉng ƒëang ph√°t tri·ªÉn!', 'info');
        }

        // Load Courses with Caching
        async function loadCourses() {
            const loadingEl = document.getElementById('loading-courses');
            const gridEl = document.getElementById('courses-grid');

            const CACHE_KEY = isLoggedIn ? `courses_${userData.email}` : 'courses_public';
            const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

            try {
                // Check cache first
                const cachedData = getCachedCourses(CACHE_KEY, CACHE_DURATION);

                if (cachedData) {
                    // Show cached data immediately (optimistic rendering)
                    loadingEl.classList.add('hidden');
                    gridEl.classList.remove('hidden');
                    renderCourses(cachedData);

                    // Fetch fresh data in background
                    fetchCoursesInBackground(CACHE_KEY);
                    return;
                }

                // No cache, show loading
                loadingEl.classList.remove('hidden');
                gridEl.classList.add('hidden');

                courses = []; // Use global variable

                if (isLoggedIn) {
                    // Fetch courses with activation status
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: "getCourses",
                            email: userData.email
                        })
                    });
                    const result = await response.json();
                    if (result.success) {
                        courses = result.data;
                    }
                } else {
                    // Fetch all available courses (public)
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: "getAllAvailableCourses"
                        })
                    });
                    const result = await response.json();
                    if (result.success) {
                        courses = result.data;
                    }
                }

                // Cache the result
                setCachedCourses(CACHE_KEY, courses);

                // Hide loading, show grid
                loadingEl.classList.add('hidden');
                gridEl.classList.remove('hidden');

                renderCourses(courses);
            } catch (error) {
                console.error('Error loading courses:', error);
                loadingEl.classList.add('hidden');
                gridEl.classList.remove('hidden');
                showToast('L·ªói t·∫£i danh s√°ch kh√≥a h·ªçc!', 'error');
            }
        }

        // Get cached courses
        function getCachedCourses(key, duration) {
            try {
                const cached = localStorage.getItem(key);
                if (!cached) return null;

                const { data, timestamp } = JSON.parse(cached);
                const now = Date.now();

                // Check if cache is still valid
                if (now - timestamp < duration) {
                    return data;
                }

                // Cache expired, remove it
                localStorage.removeItem(key);
                return null;
            } catch (e) {
                return null;
            }
        }

        // Set cached courses
        function setCachedCourses(key, data) {
            try {
                const cacheData = {
                    data: data,
                    timestamp: Date.now()
                };
                localStorage.setItem(key, JSON.stringify(cacheData));
            } catch (e) {
                console.warn('Failed to cache courses:', e);
            }
        }

        // Fetch courses in background and update if changed
        async function fetchCoursesInBackground(cacheKey) {
            console.log("üöÄ Starting fetchCoursesInBackground...");
            try {
                let tempCourses = []; // Temporary variable for background fetch

                if (isLoggedIn) {
                    console.log("User is logged in. Fetching personal courses...");
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: "getCourses",
                            email: userData.email
                        })
                    });
                    const result = await response.json();
                    if (result.success) {
                        tempCourses = result.data;
                    }
                } else {
                    console.log("User is Guest. Fetching all available courses...");
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: "getAllAvailableCourses"
                        })
                    });
                    console.log("Response received from Backend.");

                    const result = await response.json();
                    console.log("JSON parsed successfully:", result);

                    // --- DEBUG LOGGING ---
                    if (result.debug) {
                        console.group("üî• BACKEND DEBUG: getAllAvailableCourses");
                        console.log(result.debug.join('\n'));
                        console.groupEnd();
                    } else {
                        console.warn("‚ö†Ô∏è No 'debug' field in response. Did you redeploy Backend?");
                    }
                    // ---------------------

                    if (result.success) {
                        tempCourses = result.data;
                        console.log(`Fetched ${tempCourses.length} courses.`);
                    } else {
                        console.error("Backend error:", result.message);
                    }
                }

                // Update global courses
                courses = tempCourses;

                // Update cache
                setCachedCourses(cacheKey, tempCourses);

                // Re-render
                renderCourses();

            } catch (e) {
                console.error("‚ùå Error in fetchCoursesInBackground:", e);
            }
        }

        // Render Courses
        function renderCourses(data) {
            const list = data || courses; // Use argument or global courses
            const grid = document.getElementById('courses-grid');
            grid.innerHTML = '';

            if (!list || list.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #666;">Ch∆∞a c√≥ kh√≥a h·ªçc n√†o.</p>';
                return;
            }

            list.forEach(course => {
                const card = document.createElement('div');
                card.className = 'course-card';

                // Badges
                const badges = [];
                if (course.isFree) {
                    badges.push('<span class="badge badge-free">MI·ªÑN PH√ç</span>');
                } else {
                    badges.push('<span class="badge badge-paid">C√ì PH√ç</span>');
                }

                if (course.isActivated) {
                    badges.push('<span class="badge badge-activated">ƒê√É K√çCH HO·∫†T</span>');
                }

                // Action Buttons Logic
                let actionButton = '';
                let progressUI = '';

                if (course.isActivated) {
                    // ƒê√£ k√≠ch ho·∫°t -> Hi·ªán % v√† N√∫t "V√†o h·ªçc ti·∫øp"
                    const percent = course.percentComplete || 0;
                    progressUI = `
                        <div style="margin-top: 10px;">
                            <span class="percent-text"><i class="fas fa-chart-line"></i> Ti·∫øn ƒë·ªô: ${percent}%</span>
                            <div class="course-progress-container">
                                <div class="course-progress-fill" style="width: ${percent}%"></div>
                            </div>
                        </div>
                    `;
                    // Escape single quotes in title for onclick attribute
                    const escapedTitle = course.title.replace(/'/g, "\\'");
                    actionButton = `
                        <button class="btn-continue" onclick="continueLearning('${course.id}', '${escapedTitle}')">
                            <i class="fas fa-play-circle"></i> V√†o h·ªçc ti·∫øp
                        </button>
                    `;
                } else {
                    // Ch∆∞a k√≠ch ho·∫°t ho·∫∑c ch∆∞a ƒëƒÉng nh·∫≠p
                    if (course.isFree) {
                        // Mi·ªÖn ph√≠ -> N√∫t "H·ªçc lu√¥n" (H·ªçc ƒë∆∞·ª£c nh∆∞ng kh√¥ng l∆∞u)
                        const escapedTitle = course.title.replace(/'/g, "\\'");
                        actionButton = `
                            <button class="btn-start" onclick="handlePublicCourseInteract('${course.id}', true, '${escapedTitle}')">
                                <i class="fas fa-eye"></i> H·ªçc lu√¥n
                            </button>
                        `;
                    } else {
                        // C√≥ ph√≠ -> N√∫t "K√≠ch ho·∫°t ngay"
                        actionButton = `
                            <button class="btn-activate" onclick="handlePublicCourseInteract('${course.id}', false)">
                                <i class="fas fa-bolt"></i> K√≠ch ho·∫°t ngay üöÄ
                            </button>
                        `;
                    }
                }

                // Image URL with fallback (using data URI to avoid network issues)
                // Escape % as %25 is already done, but need to escape quotes for HTML attribute
                const placeholderSVG = 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22180%22%3E%3Crect width=%22400%22 height=%22180%22 fill=%22%23667eea%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22Arial, sans-serif%22 font-size=%2224%22 fill=%22%23ffffff%22%3EKh√≥a H·ªçc%3C/text%3E%3C/svg%3E';
                const imageUrl = course.imageUrl || placeholderSVG;

                card.innerHTML = `
                    <img src="${imageUrl}" 
                         alt="${course.title}" 
                         class="course-image"
                         loading="lazy"
                         onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22180%22%3E%3Crect fill=%22%23667eea%22 width=%22400%22 height=%22180%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22 fill=%22white%22 font-size=%2224%22%3EKh√≥a H·ªçc%3C/text%3E%3C/svg%3E';">
                    <div class="course-content">
                        <div class="course-header">
                            <i class="fas ${course.icon || 'fa-book'} course-icon"></i>
                            <h3 class="course-title">${course.title}</h3>
                        </div>
                        <div class="course-badges">
                            ${badges.join('')}
                        </div>
                        ${progressUI}
                        <p class="course-desc">${course.desc || 'M√¥ t·∫£ kh√≥a h·ªçc'}</p>
                        <div class="course-actions">
                            ${actionButton}
                        </div>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        // Handle Activate Button Click
        let countdownInterval = null;
        let currentCourseId = null;
        let activateFileData = null;

        async function handleActivate(courseId) {
            console.log("üöÄ START handleActivate for:", courseId);

            if (!isLoggedIn) {
                showLoginModal();
                return;
            }

            // L∆∞u courseId hi·ªán t·∫°i
            currentCourseId = courseId;

            // T√¨m th√¥ng tin kh√≥a h·ªçc
            const course = courses.find(c => c.id === courseId);
            if (!course) {
                showToast('Kh√¥ng t√¨m th·∫•y th√¥ng tin kh√≥a h·ªçc!', 'error');
                return;
            }

            // Hi·ªÉn th·ªã modal
            showActivateModal(course);

            // Fetch th√¥ng tin c·ªçc t·ª´ backend
            try {
                // Hi·ªÉn th·ªã tr·∫°ng th√°i loading trong khi fetch
                document.getElementById('activate-loading').style.display = 'block';
                document.getElementById('activate-body').style.display = 'none';

                // Check xem h·ªçc vi√™n c√≥ ph·∫£i 86 ng√†y kh√¥ng
                const is86Days = await checkIf86DaysStudent();

                console.log("üßê Check Logic -> is86Days:", is86Days, "| isFree:", course.isFree);

                if (is86Days || course.isFree) {
                    showWaiverUI();
                } else {
                    // G·ªçi backend ƒë·ªÉ l·∫•y th√¥ng tin c·ªçc th·ª±c
                    const depositResponse = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'getCourseDepositInfo',
                            courseId: courseId
                        })
                    });

                    const depositResult = await depositResponse.json();
                    console.log("üî• ACTIVATION DEBUG: Received deposit info:", depositResult);

                    if (depositResult && depositResult.id) {
                        // Hi·ªÉn th·ªã form c·ªçc v·ªõi th√¥ng tin th·ª±c t·ª´ backend
                        showDepositUI({
                            depositFee: depositResult.depositFee || 0,
                            stk: depositResult.stk || "1903 8297 6140 19",
                            tenChuTK: depositResult.tenChuTK || "NGUYEN BIEN CUONG",
                            nganHang: depositResult.nganHang || "TECHCOMBANK",
                            qrLink: depositResult.qrLink || "https://img.vietqr.io/image/TCB-19038297614019-compact.png",
                            zaloLink: depositResult.zaloLink || "",
                            paymentContent: `Coc ${courseId}`
                        });
                    } else {
                        // Fallback n·∫øu kh√¥ng l·∫•y ƒë∆∞·ª£c th√¥ng tin
                        showDepositUI({
                            depositFee: 0,
                            stk: "1903 8297 6140 19",
                            tenChuTK: "NGUYEN BIEN CUONG",
                            nganHang: "TECHCOMBANK",
                            qrLink: "https://img.vietqr.io/image/TCB-19038297614019-compact.png",
                            paymentContent: `Coc ${courseId}`
                        });
                    }
                }

                // K·∫øt th√∫c loading, hi·ªÉn th·ªã n·ªôi dung
                document.getElementById('activate-loading').style.display = 'none';
                document.getElementById('activate-body').style.display = 'block';
            } catch (error) {
                console.error('Error fetching deposit info:', error);
                showToast('L·ªói khi t·∫£i th√¥ng tin c·ªçc!', 'error');
            }
        }


        // Handle Continue Learning Button
        function continueLearning(courseId) {
            // Redirect to course player with course ID
            window.location.href = `course-play.html?id=${courseId}`;
        }

        // Handle Start Course Button (for free courses)
        function startCourse(courseId) {
            if (!isLoggedIn) {
                showLoginModal();
            } else {
                continueLearning(courseId);
            }
        }

        // === ACTIVATION MODAL FUNCTIONS ===

        function showActivateModal(course) {
            const modal = document.getElementById('activate-modal');
            document.getElementById('activate-course-name').textContent = course.title;
            document.getElementById('activate-course-desc').innerHTML = course.desc || ''; // Use innerHTML to render HTML tags

            // Kh·ªüi t·∫°o tr·∫°ng th√°i ban ƒë·∫ßu: hi·ªán loading, ·∫©n body
            document.getElementById('activate-loading').style.display = 'block';
            document.getElementById('activate-body').style.display = 'none';

            modal.classList.remove('hidden');

            // Reset file input
            activateFileData = null;
            document.getElementById('activate-receipt').value = '';
            document.getElementById('activate-preview').style.display = 'none';
        }

        function closeActivateModal() {
            const modal = document.getElementById('activate-modal');
            modal.classList.add('hidden');
            currentCourseId = null;
            activateFileData = null;
        }

        async function checkIf86DaysStudent() {
            // G·ªçi backend ƒë·ªÉ check (t·∫°m th·ªùi return false, sau s·∫Ω implement)
            // TODO: Implement API call
            return false;
        }

        function showWaiverUI() {
            document.getElementById('waiver-info').style.display = 'block';
            document.getElementById('deposit-info').style.display = 'none';
        }

        function showDepositUI(depositInfo) {
            document.getElementById('waiver-info').style.display = 'none';
            document.getElementById('deposit-info').style.display = 'block';

            // Populate deposit info
            document.getElementById('deposit-amount').textContent = depositInfo.depositFee.toLocaleString('vi-VN') + 'ƒë';
            document.getElementById('deposit-stk').textContent = depositInfo.stk;
            document.getElementById('deposit-name').textContent = depositInfo.tenChuTK;
            document.getElementById('deposit-bank').textContent = depositInfo.nganHang;
            document.getElementById('deposit-content').textContent = depositInfo.paymentContent;

            // Show QR if available
            if (depositInfo.qrLink) {
                const qrImg = document.getElementById('deposit-qr');
                qrImg.src = depositInfo.qrLink;
                qrImg.style.display = 'block';
            }

            // Setup file upload handler
            const fileInput = document.getElementById('activate-receipt');
            fileInput.addEventListener('change', handleActivateFileUpload);
        }

        function handleActivateFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('K√≠ch th∆∞·ªõc file kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB!', 'error');
                event.target.value = '';
                return;
            }

            // Convert to base64
            const reader = new FileReader();
            reader.onload = function (e) {
                const base64 = e.target.result.split(',')[1];
                activateFileData = {
                    base64: base64,
                    name: file.name,
                    type: file.type
                };

                // Show preview
                const preview = document.getElementById('activate-preview');
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        async function confirmActivation() {
            if (!currentCourseId) {
                showToast('L·ªói: Kh√¥ng t√¨m th·∫•y m√£ kh√≥a h·ªçc!', 'error');
                return;
            }

            // Check if waived or need file
            const isWaived = document.getElementById('waiver-info').style.display !== 'none';

            if (!isWaived && !activateFileData) {
                showToast('Vui l√≤ng upload ·∫£nh minh ch·ª©ng thanh to√°n!', 'error');
                return;
            }

            // Show loading
            const btn = document.getElementById('confirm-activate-btn');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'activateCourse',
                        email: userData.email,
                        courseId: currentCourseId,
                        fileData: activateFileData ? activateFileData.base64 : null,
                        fileName: activateFileData ? activateFileData.name : null,
                        fileType: activateFileData ? activateFileData.type : null
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showToast(result.message, 'success');
                    closeActivateModal();

                    // Clear cache v√† reload courses
                    clearCoursesCache();
                    await loadCourses();

                    // Optionally open Zalo link
                    if (result.zaloLink) {
                        setTimeout(() => {
                            if (confirm('B·∫°n c√≥ mu·ªën tham gia nh√≥m Zalo c·ªßa kh√≥a h·ªçc kh√¥ng?')) {
                                window.open(result.zaloLink, '_blank');
                            }
                        }, 1000);
                    }
                } else {
                    showToast(result.message || 'C√≥ l·ªói x·∫£y ra!', 'error');
                }
            } catch (error) {
                console.error('Error activating course:', error);
                showToast('L·ªói k·∫øt n·ªëi! Vui l√≤ng th·ª≠ l·∫°i.', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        // Handle Public User Interactions (Try or Activate)
        function handlePublicCourseInteract(courseId, isFree) {
            if (!isLoggedIn) {
                if (isFree) {
                    // N·∫øu l√† kh√≥a mi·ªÖn ph√≠ -> Cho ph√©p h·ªçc th·ª≠ nh∆∞ng c·∫£nh b√°o
                    showToast('B·∫°n ƒëang h·ªçc th·ª≠ v·ªõi t∆∞ c√°ch kh√°ch. Ti·∫øn ƒë·ªô s·∫Ω kh√¥ng ƒë∆∞·ª£c l∆∞u!', 'warning');
                    setTimeout(() => {
                        window.location.href = `course-play.html?id=${courseId}`;
                    }, 1500);
                } else {
                    // N·∫øu l√† kh√≥a c√≥ ph√≠ -> Y√™u c·∫ßu ƒëƒÉng nh·∫≠p ƒë·ªÉ k√≠ch ho·∫°t
                    showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ k√≠ch ho·∫°t kh√≥a h·ªçc n√†y!', 'info');
                    showLoginModal();
                }
            } else {
                // ƒê√£ ƒëƒÉng nh·∫≠p (l√Ω thuy·∫øt th√¨ n√∫t n√†y kh√¥ng hi·ªán n·∫øu ƒë√£ ƒëƒÉng nh·∫≠p v√† k√≠ch ho·∫°t, 
                // nh∆∞ng n·∫øu ch∆∞a k√≠ch ho·∫°t th√¨ x·ª≠ l√Ω nh∆∞ n√∫t k√≠ch ho·∫°t)
                if (!isFree) {
                    handleActivate(courseId); // G·ªçi h√†m k√≠ch ho·∫°t
                } else {
                    continueLearning(courseId);
                }
            }
        }

        function clearCoursesCache() {
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.startsWith('courses_')) {
                    localStorage.removeItem(key);
                }
            });
        }

        // Show Login Modal with Countdown
        function showLoginModal() {
            const modal = document.getElementById('login-modal');
            const countdownEl = document.getElementById('countdown');

            modal.classList.remove('hidden');

            let timeLeft = 10;
            countdownEl.textContent = timeLeft;

            // Clear any existing interval
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            // Start countdown
            countdownInterval = setInterval(() => {
                timeLeft--;
                countdownEl.textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    closeLoginModal();
                }
            }, 1000);
        }

        // Close Login Modal
        function closeLoginModal() {
            const modal = document.getElementById('login-modal');
            modal.classList.add('hidden');

            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }

        // Go to Login Page
        function goToLogin() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            window.location.href = 'login.html';
        }

        // Load Roadmap (for logged-in users)
        // Load Roadmap with Caching
        async function loadRoadmap() {
            const CACHE_KEY = `roadmap_${userData.code}`;
            const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

            try {
                // Check cache first
                const cachedData = getCachedCourses(CACHE_KEY, CACHE_DURATION);

                if (cachedData) {
                    // Show cached data immediately
                    renderRoadmap(cachedData);
                    document.getElementById('roadmap-section').classList.remove('hidden');

                    // Fetch fresh data in background
                    fetchRoadmapInBackground(CACHE_KEY);
                    return;
                }

                // No cache, fetch from server
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: "getRoadmap",
                        studentCode: userData.code
                    })
                });

                const result = await response.json();
                if (result.success) {
                    // Cache the result
                    setCachedCourses(CACHE_KEY, result.data);

                    renderRoadmap(result.data);
                    document.getElementById('roadmap-section').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading roadmap:', error);
            }
        }

        // Fetch roadmap in background
        async function fetchRoadmapInBackground(cacheKey) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: "getRoadmap",
                        studentCode: userData.code
                    })
                });

                const result = await response.json();
                if (result.success) {
                    // Update cache
                    setCachedCourses(cacheKey, result.data);

                    // Check if data changed, update UI silently
                    const currentCache = getCachedCourses(cacheKey, Infinity);
                    if (JSON.stringify(currentCache) !== JSON.stringify(result.data)) {
                        renderRoadmap(result.data);
                    }
                }
            } catch (e) {
                console.warn('Background roadmap fetch failed:', e);
            }
        }

        // Render Roadmap
        function renderRoadmap(roadmapData) {
            const container = document.getElementById('roadmap-container');
            container.innerHTML = '';

            // Define roadmap steps (you can customize this)
            const steps = [
                { id: 'step1', title: 'ƒêƒÉng k√Ω t√†i kho·∫£n', desc: 'Ho√†n th√†nh ƒëƒÉng k√Ω' },
                { id: 'step2', title: 'K√≠ch ho·∫°t kh√≥a h·ªçc ƒë·∫ßu ti√™n', desc: 'Ch·ªçn v√† k√≠ch ho·∫°t kh√≥a h·ªçc' },
                { id: 'step3', title: 'Ho√†n th√†nh b√†i h·ªçc ƒë·∫ßu ti√™n', desc: 'H·ªçc v√† l√†m b√†i t·∫≠p' },
                { id: 'step4', title: 'Tham gia c·ªông ƒë·ªìng', desc: 'K·∫øt n·ªëi v·ªõi h·ªçc vi√™n kh√°c' }
            ];

            steps.forEach((step, index) => {
                const stepData = roadmapData[step.id];
                const status = stepData ? stepData.status : 'pending';
                const statusClass = status === 'done' ? 'done' : status === 'active' ? 'active' : '';

                const stepEl = document.createElement('div');
                stepEl.className = `roadmap-step ${statusClass}`;
                stepEl.innerHTML = `
                    <div class="step-content">
                        <div class="step-title">${step.title}</div>
                        <div>${step.desc}</div>
                    </div>
                `;
                container.appendChild(stepEl);
            });
        }

        // Navigate to course page
        function continueLearning(courseId, courseTitle) {
            console.log('=== continueLearning called ===');
            console.log('courseId:', courseId);
            console.log('courseTitle:', courseTitle);

            if (courseTitle) {
                const title = encodeURIComponent(courseTitle);
                const url = `course-play.html?id=${courseId}&title=${title}`;
                console.log('Navigating to:', url);
                window.location.href = url;
            } else {
                console.warn('‚ö†Ô∏è No title provided, falling back to courses array');
                const course = courses.find(c => c.id === courseId);
                if (course && course.title) {
                    const title = encodeURIComponent(course.title);
                    window.location.href = `course-play.html?id=${courseId}&title=${title}`;
                } else {
                    window.location.href = `course-play.html?id=${courseId}`;
                }
            }
        }

        function handlePublicCourseInteract(courseId, isFree, courseTitle) {
            console.log('=== handlePublicCourseInteract called ===');
            console.log('courseId:', courseId, 'isFree:', isFree, 'courseTitle:', courseTitle);

            if (isFree) {
                // Free course - go directly
                if (courseTitle) {
                    const title = encodeURIComponent(courseTitle);
                    const url = `course-play.html?id=${courseId}&title=${title}`;
                    console.log('Navigating to:', url);
                    window.location.href = url;
                } else {
                    console.warn('‚ö†Ô∏è No title provided, falling back to courses array');
                    const course = courses.find(c => c.id === courseId);
                    if (course && course.title) {
                        const title = encodeURIComponent(course.title);
                        window.location.href = `course-play.html?id=${courseId}&title=${title}`;
                    } else {
                        window.location.href = `course-play.html?id=${courseId}`;
                    }
                }
            } else {
                // Paid course - show activation modal
                handleActivate(courseId);
            }
        }

        // Show Toast Notification
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');

            toast.className = `toast ${type} show`;
            toastMessage.textContent = message;

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ===== CHATBOT FUNCTIONS =====
        let conversationHistory = [];

        function initChatbot() {
            const fab = document.getElementById('chatbot-fab');
            const closeBtn = document.getElementById('chatbot-close');
            const sendBtn = document.getElementById('chatbot-send');
            const input = document.getElementById('chatbot-input');

            fab.addEventListener('click', toggleChatbot);
            closeBtn.addEventListener('click', closeChatbot);
            sendBtn.addEventListener('click', sendMessage);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        function toggleChatbot() {
            const container = document.getElementById('chatbot-container');
            const fab = document.getElementById('chatbot-fab');
            container.classList.toggle('active');
            fab.classList.toggle('active');

            if (container.classList.contains('active')) {
                document.getElementById('chatbot-input').focus();
            }
        }

        function closeChatbot() {
            const container = document.getElementById('chatbot-container');
            const fab = document.getElementById('chatbot-fab');
            container.classList.remove('active');
            fab.classList.remove('active');
        }

        async function sendMessage() {
            const input = document.getElementById('chatbot-input');
            const message = input.value.trim();

            if (!message) return;

            // Add user message to UI
            addMessageToUI(message, 'user');
            input.value = '';

            // Add to conversation history
            conversationHistory.push({
                role: 'user',
                content: message
            });

            // Show typing indicator
            showTypingIndicator();

            try {
                // Send to backend
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'chatWithAI',
                        message: message,
                        conversationHistory: conversationHistory,
                        email: isLoggedIn ? userData.email : ""
                    })
                });

                const result = await response.json();
                removeTypingIndicator();

                if (result.success) {
                    const aiMessage = result.message;
                    addMessageToUI(aiMessage, 'ai');

                    // Add to conversation history
                    conversationHistory.push({
                        role: 'ai',
                        content: aiMessage
                    });

                    // Keep conversation history limited (last 20 messages)
                    if (conversationHistory.length > 20) {
                        conversationHistory = conversationHistory.slice(-20);
                    }
                } else {
                    addMessageToUI('‚ùå ' + (result.message || 'L·ªói x·ª≠ l√Ω'), 'ai');
                }
            } catch (error) {
                removeTypingIndicator();
                console.error('Chatbot error:', error);
                addMessageToUI('‚ùå L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i!', 'ai');
            }

            // Auto-scroll to bottom
            const messagesContainer = document.getElementById('chatbot-messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addMessageToUI(text, sender) {
            const messagesContainer = document.getElementById('chatbot-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.textContent = text;

            messageDiv.appendChild(bubble);
            messagesContainer.appendChild(messageDiv);
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chatbot-messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        // Initialize chatbot when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initChatbot();
        });
    </script>

    <!-- Chatbot UI -->
    <button id="chatbot-fab" class="chatbot-fab" title="Tr·ª£ l√Ω AI">
        <i class="fas fa-comments"></i>
    </button>

    <div id="chatbot-container" class="chatbot-container">
        <div class="chatbot-header">
            <h3>ü§ñ Tr·ª£ l√Ω AI</h3>
            <button id="chatbot-close" class="chatbot-close" title="ƒê√≥ng">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="chatbot-messages" class="chatbot-messages">
            <div class="message ai">
                <div class="message-bubble">
                    üëã Xin ch√†o! T√¥i l√† tr·ª£ l√Ω AI c·ªßa H·ªçc vi·ªán BRK.
                    <br><br>
                    üéì T√¥i s·∫Ω h·ªó tr·ª£ b·∫°n v·ªõi c√°c c√¢u h·ªèi trong <strong>n·ªôi dung c√°c kh√≥a h·ªçc ƒë√£ k√≠ch ho·∫°t</strong> c·ªßa b·∫°n.
                    <br><br>
                    üìö H√£y h·ªèi t√¥i b·∫•t c·ª© ƒëi·ªÅu g√¨ v·ªÅ c√°c b√†i h·ªçc ho·∫∑c n·ªôi dung kh√≥a h·ªçc. C√≥ g√¨ t√¥i gi√∫p b·∫°n?
                </div>
            </div>
        </div>
        <div class="chatbot-input-area">
            <input 
                id="chatbot-input" 
                class="chatbot-input" 
                type="text" 
                placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..."
                autocomplete="off"
            >
            <button id="chatbot-send" class="chatbot-send" title="G·ª≠i">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</body>

</html>